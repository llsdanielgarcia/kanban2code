---
stage: completed
agent: 06-✅auditor
tags: []
contexts:
  - ai-guide
skills: []
---

# Mentioning

Add @-mentioning for codebase files in the task content textarea.

## Refined Prompt

**Objective:** Implement an inline autocomplete system for file mentions in TaskModal's content field.

**Scope:**

- Triggers when user types `@` in the content textarea
- Searches workspace files (exclude node_modules, .git, dist, out, .kanban2code)
- Shows dropdown with fuzzy-filtered results
- Inserts selected file path relative to workspace root (e.g., `src/services/prompt-builder.ts`)

**Components to create/modify:**

1. `src/webview/ui/components/MentionsTextarea.tsx` (new)
   - Wraps textarea with @-mention detection
   - Manages dropdown state, position, keyboard navigation (up/down/enter/escape)
   - Debounced search requests to extension host
   - Handles selection → insert path at cursor, remove `@` trigger

2. `src/webview/ui/components/TaskModal.tsx`
   - Replace content `<textarea>` with `<MentionsTextarea />`
   - Pass value/onChange props

3. `src/extension.ts` or message handler
   - Handle `SearchFiles` message from webview
   - Use `vscode.workspace.findFiles` with exclusion patterns
   - Return matching file paths

**Definition of Done:**

- [ ] Typing `@` in content field triggers file search
- [ ] Dropdown shows matching files with fuzzy filter
- [ ] Keyboard navigation works (up/down/enter/escape)
- [ ] Selecting a file inserts path at cursor position
- [ ] Clicking outside dismisses dropdown
- [ ] Works in both create and edit task modes

---

## Review

**Rating: 7/10**

**Verdict: NEEDS WORK**

### Summary
The @-mention implementation is well-architected and fully functional for the task creation flow, with clean component separation, proper requestId correlation, debounced search, and complete keyboard navigation. However, the DoD explicitly requires the feature to work in edit mode, which uses `TaskEditorModal.tsx` with a Monaco editor — and that modal was not updated.

### Findings

#### Blockers
- [ ] **Edit mode not supported**: `TaskEditorModal.tsx` uses a Monaco editor for task editing, not a textarea. `MentionsTextarea` was only wired into `TaskModal.tsx` (create flow). The DoD item "Works in both create and edit task modes" is not satisfied. Adding mention support to Monaco requires a completion provider with a different approach. - `src/webview/ui/components/TaskEditorModal.tsx`

#### High Priority
- [ ] **`findFiles` capped at 50 before filtering**: `SidebarProvider.ts:433` passes `50` as the limit to `vscode.workspace.findFiles`. If the workspace has more than 50 files, matches that fall outside the first 50 returned files are silently missed. The limit should be raised (e.g., 500) so the subsequent `.slice(0, 20)` filter operates on a representative set. - `src/webview/SidebarProvider.ts:429-438`

#### Medium Priority
- [ ] **Substring match, not fuzzy filter**: The Scope says "fuzzy-filtered results". The implementation uses `path.toLowerCase().includes(queryLower)`, which is a substring search. A fuzzy matcher (e.g., score-based character subsequence) would be more useful when users type abbreviations like `spb` to match `src/services/prompt-builder.ts`. - `src/webview/SidebarProvider.ts:435`
- [ ] **Dropdown position approximation**: `updateDropdownPosition` calculates position using line count × parsed `lineHeight`, which ignores text wrapping and doesn't adjust for character-level cursor position. The dropdown may appear at an incorrect vertical offset for multi-line content. - `src/webview/ui/components/MentionsTextarea.tsx:56-68`

#### Low Priority / Nits
- [ ] **SVG icon is a bookmark, not a file**: The SVG path at `MentionsTextarea.tsx:215` renders a bookmark shape rather than a generic file icon. Cosmetic but slightly misleading. - `src/webview/ui/components/MentionsTextarea.tsx:212-216`
- [ ] **`@` after punctuation doesn't trigger**: `findMentionTrigger` requires the character before `@` to be a space, newline, or the start of the string. Typing `(@file` or `[@file` won't trigger the dropdown, which may surprise users. - `src/webview/ui/components/MentionsTextarea.tsx:49-50`

### Test Assessment
- Coverage: No tests were provided for `MentionsTextarea` or the `SearchFiles` host handler.
- Missing tests: unit tests for `findMentionTrigger`, `selectFile` insertion logic, and the `SearchFiles`/`FilesSearched` message round-trip.

### What's Good
- RequestId correlation prevents stale search results from appearing in a race condition — clean design.
- 150ms debounce is well-chosen: reduces round-trips without feeling sluggish.
- Click-outside + onBlur dual-dismissal is robust and handles edge cases correctly.
- VS Code CSS variables used throughout — the dropdown will theme-match automatically.
- Message types (`SearchFiles`, `FilesSearched`) are properly registered in the messaging registry.
- Exclusion patterns (node_modules, .git, dist, out, .kanban2code, coverage, .next, build) are thorough.

### Recommendations
- For the Monaco edit-mode support, consider a `monaco.languages.registerCompletionItemProvider` with `triggerCharacters: ['@']` inside `TaskEditorModal`.
- Raise the `findFiles` limit to 200–500 and do the fuzzy/substring filtering server-side on that larger set.

---

## Re-Audit (Pass 2)

**Rating: 9/10**

**Verdict: ACCEPTED**

### Summary
All blockers and high-priority findings from the first review have been addressed. The implementation now covers both create and edit modes, uses genuine fuzzy scoring, and operates on a much larger file set.

### Resolved Findings
- **Edit mode**: `TaskEditorModal.tsx` now registers a Monaco `CompletionItemProvider` with `triggerCharacters: ['@']`, using the same `SearchFiles`/`FilesSearched` requestId protocol via a Promise bridge. Clean approach.
- **findFiles limit**: Raised from 50 → 500.
- **Fuzzy scoring**: Replaced `includes` with a proper subsequence scorer (consecutive +3, word-boundary +2, other +1) in `SidebarProvider.ts`.
- **SVG icon**: Updated to a proper file icon.
- **`@` after punctuation**: `findMentionTrigger` now uses `/[a-zA-Z0-9_/\\]/` regex, so `(@file` and `[@file` correctly trigger the dropdown.

### Remaining Nits (non-blocking)
- Textarea dropdown position is still approximate (line-count × lineHeight), but this is a known hard problem with textareas and acceptable for this use case.
- No unit tests for `findMentionTrigger`, `selectFile`, or the `SearchFiles` host handler — worth adding in a follow-up.
