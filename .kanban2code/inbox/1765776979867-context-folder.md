---
stage: completed
tags: []
contexts:
  - architecture
  - ai-guide
agent: code-reviewer
---

# Context folder

I'd like to add the option to select a folder as context, since sometimes an entire folder could contain files related to the context

<context-pack timestamp="2025-12-16T04:46:00.000Z" task="Add folder selection as context option">
  <meta>
    <scope>context system, UI components</scope>
    <stack>
      <language>TypeScript</language>
      <framework>React</framework>
      <build-tools>
        <tool>esbuild</tool>
        <tool>bun</tool>
      </build-tools>
      <test-tools>
        <tool>vitest</tool>
      </test-tools>
    </stack>
  </meta>

  <task>
    <original><![CDATA[I'd like to add the option to select a folder as context, since sometimes an entire folder could contain files related to the context]]></original>
    <clarifying-questions>
      <question>How should folder context be displayed in the context picker - should it show as a special type of context item with a folder icon?</question>
      <question>Should folder context include all files recursively or just the immediate files in the selected folder?</question>
      <question>How should folder paths be stored in the task frontmatter - as relative paths from the kanban root?</question>
      <question>Should there be any file type filtering when including folder context (e.g., only include .md, .ts, .tsx files)?</question>
    </clarifying-questions>
    <assumptions>
      <item>Folder context should be displayed with a distinct icon in the context picker to differentiate from file contexts</item>
      <item>Folder context should include all files recursively by default</item>
      <item>Folder paths should be stored as relative paths from the kanban root in task frontmatter</item>
      <item>No file type filtering by default, but this could be a future enhancement</item>
    </assumptions>
    <refined-prompt><![CDATA[
Objective: Add folder selection as a context option in Kanban2Code to allow users to select entire folders as context for tasks.

Context: Currently, the context system only supports individual context files from the _context directory or explicit file paths. Users need the ability to select entire folders as context when multiple related files in a directory are relevant to a task.

Acceptance criteria:
- Add folder selection capability to the context picker UI
- Store folder paths in task frontmatter alongside existing context references
- Extend the context loading system to handle folder paths and include all files in the folder
- Update the prompt builder to include folder contents when building XML prompts
- Add folder icon and visual distinction in the context picker
- Ensure folder paths are stored as relative paths from the kanban root
- Add tests for folder context functionality

Non-goals:
- File type filtering for folder contents (can be added later)
- Folder exclusion patterns (can be added later)
- Recursive depth limiting (can be added later)

Notes/constraints:
- Maintain backward compatibility with existing context file references
- Use existing VS Code file picker API with folder selection enabled
- Follow the existing context loading pattern in the prompt builder
- Ensure folder paths are validated for security (no path traversal)
- Update both TaskModal and TaskEditorModal components
    ]]></refined-prompt>
  </task>

  <architecture>
    <primary-source path="docs/architecture.md" />
    <key-points>
      <item>Context system uses 9-layer context building in prompt-builder.ts</item>
      <item>Custom contexts are loaded via loadCustomContexts() in context.ts</item>
      <item>Context picker UI is implemented in ContextPicker.tsx component</item>
      <item>Context references are stored in task frontmatter as 'contexts' array</item>
      <item>Messaging system handles context-related messages between UI and backend</item>
    </key-points>
    <extracts>
      <extract source="src/services/context.ts:269-290">
        <![CDATA[export async function loadCustomContexts(root: string, contextNames?: string[] | null): Promise<string> {
  if (!contextNames || contextNames.length === 0) return '';

  const contents = await Promise.all(
    contextNames.map(async (ctx) => {
      const normalized = ensureExtension(ctx);
      const isExplicitPath = normalized.includes('/') || normalized.includes('\\');
      if (isExplicitPath) {
        return readFileIfExists(root, normalized);
      }

      const fromContextDir = path.join(CONTEXT_FOLDER, normalized);
      if (await fileExists(root, fromContextDir)) {
        return readFileIfExists(root, fromContextDir);
      }

      return readFileIfExists(root, normalized);
    }),
  );

  return contents.filter(Boolean).join('\n\n');
}]]>
      </extract>
      <extract source="src/webview/ui/components/ContextPicker.tsx:11-16">
        <![CDATA[interface ContextPickerProps {
  contexts: ContextFile[];
  selected: string[];
  onChange: (selected: string[]) => void;
  onCreateNew: () => void;
}]]>
      </extract>
      <extract source="src/webview/SidebarProvider.ts:387-406">
        <![CDATA[case 'PickFile': {
  const options: vscode.OpenDialogOptions = {
    canSelectMany: false,
    openLabel: 'Select',
    canSelectFiles: true,
    canSelectFolders: false,
  };
  const root = WorkspaceState.kanbanRoot;
  if (root) {
    options.defaultUri = vscode.Uri.file(root);
  }
  const fileUri = await vscode.window.showOpenDialog(options);
  if (fileUri && fileUri[0]) {
    const relativePath = root
      ? fileUri[0].fsPath.replace(root, '').replace(/^[/\\]/, '')
      : fileUri[0].fsPath;
    this._postMessage(createEnvelope('FilePicked', { path: relativePath }));
  }
  break;
}]]>
      </extract>
    </extracts>
  </architecture>

  <database>
    <status>not-detected</status>
    <engine>unknown</engine>
    <schema-sources>
    </schema-sources>
    <model>
    </model>
    <access-layer>
      <pattern>filesystem</pattern>
      <locations>
        <location path="src/services/context.ts" />
      </locations>
      <error-handling>try/catch with fallback values</error-handling>
      <transactions>not applicable</transactions>
    </access-layer>
  </database>

  <code-map>
    <files>
      <file path="src/webview/ui/components/ContextPicker.tsx" role="modify">
        <reason>UI component for selecting context files - needs to support folder selection</reason>
        <extract source="src/webview/ui/components/ContextPicker.tsx:3-9">
          <![CDATA[export interface ContextFile {
  id: string;
  name: string;
  description: string;
  path: string;
  scope?: 'global' | 'project';
}]]>
        </extract>
      </file>
      <file path="src/services/context.ts" role="modify">
        <reason>Backend service for loading contexts - needs to handle folder paths</reason>
        <extract source="src/services/context.ts:10-16">
          <![CDATA[export interface ContextFile {
  id: string;
  name: string;
  description: string;
  path: string;
  scope?: 'global' | 'project';
}]]>
        </extract>
      </file>
      <file path="src/webview/SidebarProvider.ts" role="modify">
        <reason>Handles messaging between UI and backend - needs folder picker support</reason>
        <extract source="src/webview/SidebarProvider.ts:387-406">
          <![CDATA[case 'PickFile': {
  const options: vscode.OpenDialogOptions = {
    canSelectMany: false,
    openLabel: 'Select',
    canSelectFiles: true,
    canSelectFolders: false,
  };
  const root = WorkspaceState.kanbanRoot;
  if (root) {
    options.defaultUri = vscode.Uri.file(root);
  }
  const fileUri = await vscode.window.showOpenDialog(options);
  if (fileUri && fileUri[0]) {
    const relativePath = root
      ? fileUri[0].fsPath.replace(root, '').replace(/^[/\\]/, '')
      : fileUri[0].fsPath;
    this._postMessage(createEnvelope('FilePicked', { path: relativePath }));
  }
  break;
}]]>
        </extract>
      </file>
      <file path="src/webview/messaging.ts" role="modify">
        <reason>Message type definitions - needs new message type for folder selection</reason>
        <extract source="src/webview/messaging.ts:28-60">
          <![CDATA[export const WebviewToHostMessageTypes = [
  // Filter changes can originate from sidebar or board
  'FilterChanged',
  'CreateTask',
  'MoveTask',
  'MoveTaskToLocation',
  'ArchiveTask',
  'DeleteTask',
  'CopyContext',
  'OpenTask',
  'OpenBoard',
  'OpenSettings',
  'CreateKanban',
  'CreateProject',
  'CreateContext',
  'CreateAgent',
  'CreateTemplate',
  'UpdateTemplate',
  'TaskContextMenu',
  'RequestTemplates',
  'RequestContexts',
  'RequestAgents',
  'PickFile',
  'RequestTaskContent',
  'SaveTaskContent',
  'RequestFullTaskData',
  'SaveTaskWithMetadata',
  'RequestTemplateContent',
  // Webview ready handshake - requests initial state from host
  'RequestState',
  // Basic demo/ping path used by placeholder UI
  'ALERT',
] as const;]]>
        </extract>
      </file>
      <file path="src/services/prompt-builder.ts" role="modify">
        <reason>Builds XML prompts with context - needs to handle folder paths</reason>
        <extract source="src/services/prompt-builder.ts:44-71">
          <![CDATA[async function buildContextSection(task: Task, root: string): Promise<string> {
  const [
    globalContext,
    agentContext,
    projectContext,
    phaseContext,
    stageTemplate,
    customContexts,
  ] = await Promise.all([
    loadGlobalContext(root),
    loadAgentContext(root, task.agent),
    loadProjectContext(root, task.project),
    loadPhaseContext(root, task.project, task.phase),
    loadStageTemplate(root, task.stage),
    loadCustomContexts(root, task.contexts),
  ]);

  const layers = [
    wrapSection('global', globalContext),
    wrapSection('agent', agentContext),
    wrapSection('project', projectContext),
    wrapSection('phase', phaseContext),
    wrapSection('stage_template', stageTemplate),
    wrapSection('custom', customContexts),
  ];

  return `<context>${layers.filter(Boolean).join('')}</context>`;
}]]>
        </extract>
      </file>
    </files>
    <types>
      <type name="ContextFile" source="src/services/context.ts:10-16">
        <![CDATA[export interface ContextFile {
  id: string;
  name: string;
  description: string;
  path: string;
  scope?: 'global' | 'project';
}]]>
      </type>
    </types>
    <functions>
      <function name="loadCustomContexts" source="src/services/context.ts:269-290">
        <signature><![CDATA[export async function loadCustomContexts(root: string, contextNames?: string[] | null): Promise<string>]]></signature>
        <purpose>Loads custom context files and includes them in the prompt</purpose>
        <callers>
          <caller source="src/services/prompt-builder.ts:58" />
        </callers>
      </function>
    </functions>
    <data-flow>Context picker UI → SidebarProvider → context.ts → prompt-builder.ts → XML prompt output</data-flow>
  </code-map>

  <tests>
    <framework>vitest</framework>
    <how-to-run>
      <command>bun run test</command>
    </how-to-run>
    <existing-tests>
      <test-file path="tests/context-service.test.ts">
        <patterns>mocking/fixtures/helpers</patterns>
      </test-file>
    </existing-tests>
    <required-coverage>
      <item>Test folder path detection in loadCustomContexts</item>
      <item>Test recursive file reading for folder contexts</item>
      <item>Test UI component with folder context items</item>
      <item>Test messaging for folder picker</item>
    </required-coverage>
  </tests>

  <constraints>
    <validation>
      <item>Folder paths must be validated for security (no path traversal)</item>
      <item>Only folders within the kanban root should be allowed</item>
    </validation>
    <naming>
      <item>Folder context items should be prefixed with "folder:" in the contexts array</item>
    </naming>
    <security>
      <item>Never output secrets; redact config values.</item>
    </security>
  </constraints>

  <open-questions>
    <uncertainty>How to handle large folders with many files - should there be a limit or warning?</uncertainty>
  </open-questions>

  <handoff>
    <planning-agent-ready>true</planning-agent-ready>
    <coding-agent-ready>true</coding-agent-ready>
    <next-step>Extend the ContextFile interface to support folder type and add folder picker functionality to the UI</next-step>
  </handoff>
</context-pack>

## Audit
- src/webview/messaging.ts
- src/webview/SidebarProvider.ts
- src/webview/KanbanPanel.ts
- src/webview/ui/components/ContextPicker.tsx
- src/webview/ui/styles/main.css
- src/webview/ui/components/TaskModal.tsx
- src/webview/ui/components/TaskEditorModal.tsx
- src/services/context.ts
- tests/context-service.test.ts
- .kanban2code/inbox/1765776979867-context-folder.md
