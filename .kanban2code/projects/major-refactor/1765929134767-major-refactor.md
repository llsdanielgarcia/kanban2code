---
stage: audit
tags:
  - architecture
  - p0
  - decomposition-ready
contexts:
  - architecture
  - ai-guide
---

# Major Refactor

This document tracks planned breaking changes and major refactors for Kanban2Code.

---

## Technical Specification

### 1. Request Analysis

#### Core Requirements Identified

**Refactor 1: Remove Template System**
- Delete passive template infrastructure that doesn't fit agent-driven workflow
- Remove ~34 files/references across services, UI, messaging, and tests
- Update scaffolder to skip template folder creation
- Migrate documentation and ai-guide

**Refactor 2: Agent-Driven Orchestration Pipeline**
- Create 6 new agent definitions (3 orchestration + 3 execution)
- Implement tag-based orchestration state tracking
- Update scaffolder to bundle agents with extension
- Document handoff protocols

---

### 2. High-Level Architecture

#### 2.1 Current State (Before Refactor)

```
┌─────────────────────────────────────────────────────────────────┐
│                     CURRENT ARCHITECTURE                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  User ──▶ TaskModal ──▶ TemplatePicker ──▶ Template Service    │
│              │                                   │              │
│              ▼                                   ▼              │
│         CreateTask ◀──────────────────── Load Template         │
│              │                                                  │
│              ▼                                                  │
│      Task File (.md)  ◀── template: field in frontmatter       │
│                                                                 │
│  Scaffolder ──▶ Creates _templates/tasks/ + _templates/stages/ │
│                                                                 │
│  PromptBuilder ──▶ Loads stage templates from _templates/stages│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 2.2 Target State (After Refactor)

```
┌─────────────────────────────────────────────────────────────────┐
│                     TARGET ARCHITECTURE                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ORCHESTRATION PIPELINE (Meta-workflow)                         │
│  ┌──────────┐    ┌───────────┐    ┌──────────┐                 │
│  │Roadmapper│───▶│ Architect │───▶│ Splitter │                 │
│  │ (Sonnet) │    │  (Opus)   │    │  (GLM)   │                 │
│  └──────────┘    └───────────┘    └──────────┘                 │
│       │               │                │                        │
│       ▼               ▼                ▼                        │
│   Vision doc    Architecture +    Task files                   │
│                 phases/tasks       generated                    │
│                                        │                        │
│  EXECUTION PIPELINE (5-stage)          ▼                        │
│  ┌─────────┐    ┌────────┐    ┌─────────┐                      │
│  │ Planner │───▶│ Coder  │───▶│ Auditor │                      │
│  │(Sonnet) │    │(Codex) │    │(Codex+) │                      │
│  └─────────┘    └────────┘    └─────────┘                      │
│   stage:plan    stage:code    stage:audit                      │
│                                                                 │
│  User ──▶ TaskModal ──▶ AgentPicker ──▶ Task File              │
│              │              (agents generate content)           │
│              ▼                                                  │
│         CreateTask ──▶ Minimal task, agent fills in later      │
│                                                                 │
│  Scaffolder ──▶ Creates _agents/ with bundled agent files      │
│              ──▶ NO _templates folder created                   │
│                                                                 │
│  PromptBuilder ──▶ Stage context embedded in agent instructions│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 2.3 Data Flow Changes

**Before:** User selects template → Template content pre-fills task → User edits
**After:** User creates minimal task → Assigned agent generates/refines content → User reviews

**Tag-based Orchestration State:**
```yaml
# Orchestration tags (track pipeline state)
missing-architecture    # Needs architect pass
missing-decomposition   # Needs splitter pass
architecture-ready      # Architecture complete
decomposition-ready     # Tasks generated

# Type tags (for orchestration meta-tasks)
roadmap                 # Vision/roadmap task
architecture            # Architecture task
decomposition           # Splitting task
```

---

## 3. Implementation Plan

### Phase 1: Remove Template System (MVP/Foundation)

**Goal:** Cleanly remove all template infrastructure without breaking existing functionality.

#### Task 1.1: Audit and Document Current Template Usage
**Definition of Done:**
- [ ] All 34+ files with template references documented
- [ ] Dependency graph showing removal order created
- [ ] Migration notes for existing workspaces drafted

#### Task 1.2: Remove Template Service
**Definition of Done:**
- [ ] `src/services/template.ts` deleted
- [ ] All imports of template service removed from other files
- [ ] `tests/template-service.test.ts` deleted
- [ ] Build passes without template service

#### Task 1.3: Remove Template UI Components
**Definition of Done:**
- [ ] `src/webview/ui/components/TemplatePicker.tsx` deleted
- [ ] `src/webview/ui/components/TemplateModal.tsx` deleted
- [ ] Template imports removed from `index.ts`
- [ ] TemplateIcon removed from Icons.tsx (or kept if used elsewhere)

#### Task 1.4: Update TaskModal and TaskEditorModal
**Definition of Done:**
- [ ] `TaskModal.tsx` - Template picker section removed
- [ ] `TaskEditorModal.tsx` - Template picker and loading removed
- [ ] Template warning dialog removed from TaskEditorModal
- [ ] Both modals render correctly without templates

#### Task 1.5: Remove Template Messaging
**Definition of Done:**
- [ ] `messaging.ts` - Remove template message types:
  - `TemplatesLoaded`, `TemplateContentLoaded`, `TemplateContentLoadFailed`
  - `CreateTemplate`, `UpdateTemplate`, `RequestTemplates`, `RequestTemplateContent`
- [ ] `SidebarProvider.ts` - Remove template message handlers
- [ ] `KanbanPanel.ts` - Remove template message handlers

#### Task 1.6: Remove Template Command
**Definition of Done:**
- [ ] `kanban2code.newTemplate` command removed from `commands/index.ts`
- [ ] Command removed from `package.json` contributions
- [ ] Keybinding removed if exists

#### Task 1.7: Update Scaffolder
**Definition of Done:**
- [ ] `scaffolder.ts` - Remove `_templates/tasks/` creation
- [ ] `scaffolder.ts` - Remove `_templates/stages/` creation
- [ ] `scaffolder.ts` - Remove template seeding logic
- [ ] `tests/scaffolder.test.ts` - Update tests for new behavior

#### Task 1.8: Handle Stage Templates Migration
**Definition of Done:**
- [ ] Decision made: embed stage context in agent instructions OR keep `_templates/stages/`
- [ ] `context.ts` - `loadStageTemplate()` updated or removed
- [ ] `prompt-builder.ts` - Stage template layer updated
- [ ] Stage context available to agents via alternative mechanism

#### Task 1.9: Update Assets and Constants
**Definition of Done:**
- [ ] `assets/templates.ts` - Remove task template constants
- [ ] `constants.ts` - `TEMPLATES_FOLDER` constant removed or deprecated
- [ ] Template-related code removed from `task-content.ts`

#### Task 1.10: Update Tests
**Definition of Done:**
- [ ] `template-service.test.ts` deleted
- [ ] `task-editor-modal.test.tsx` - Template tests removed
- [ ] `scaffolder.test.ts` - Template directory tests updated
- [ ] `context-service.test.ts` - Stage template tests updated
- [ ] All remaining tests pass

#### Task 1.11: Update Documentation
**Definition of Done:**
- [ ] `docs/architecture.md` - Template references removed
- [ ] `.kanban2code/_context/ai-guide.md` - Template section removed, agent-generated content emphasized
- [ ] `docs/user_guide.md` (if exists) - Template usage removed
- [ ] README updated if templates mentioned

#### Task 1.12: Cleanup Workspace Template Files
**Definition of Done:**
- [ ] `.kanban2code/_templates/tasks/` contents documented for migration
- [ ] `.kanban2code/_templates/stages/` contents documented
- [ ] Migration script or instructions for existing users created (optional)

---

### Phase 2: Agent-Driven Orchestration Pipeline (Core Features)

**Goal:** Implement the 6-agent pipeline with tag-based orchestration.

#### Task 2.1: Create Orchestration Agent Files
**Definition of Done:**
- [ ] `.kanban2code/_agents/roadmapper.md` created with full instructions
- [ ] `.kanban2code/_agents/architect.md` created with full instructions
- [ ] `.kanban2code/_agents/splitter.md` created with full instructions
- [ ] Each agent has: role, responsibilities, input/output format, handoff protocol

#### Task 2.2: Create Execution Agent Files
**Definition of Done:**
- [ ] `.kanban2code/_agents/planner.md` created (stage: plan)
- [ ] `.kanban2code/_agents/coder.md` created (stage: code)
- [ ] `.kanban2code/_agents/auditor.md` created (stage: audit)
- [ ] Each agent has: role, stage, quality criteria, output format

#### Task 2.3: Update Scaffolder for Agent Bundling
**Definition of Done:**
- [ ] Agent markdown files embedded in extension build
- [ ] `scaffolder.ts` copies bundled agents to new workspaces
- [ ] Existing agents preserved if already present (no overwrite)
- [ ] `tests/scaffolder.test.ts` verifies agent scaffolding

#### Task 2.4: Define Tag Taxonomy for Orchestration
**Definition of Done:**
- [ ] Orchestration tags added to `filters.ts` taxonomy
- [ ] Tag validation rules for orchestration state
- [ ] UI color/style for orchestration tags defined

#### Task 2.5: Update AI Guide with Orchestration Protocol
**Definition of Done:**
- [ ] `ai-guide.md` - Orchestration section added
- [ ] Handoff protocol documented (how each agent spawns next)
- [ ] Tag transition rules documented
- [ ] Examples of full pipeline provided

#### Task 2.6: Create Agent Templates in assets/agents.ts
**Definition of Done:**
- [ ] `AGENT_ROADMAPPER` constant with full agent markdown
- [ ] `AGENT_ARCHITECT` constant
- [ ] `AGENT_SPLITTER` constant
- [ ] `AGENT_PLANNER`, `AGENT_CODER`, `AGENT_AUDITOR` constants
- [ ] Scaffolder uses these constants for agent creation

#### Task 2.7: Update Documentation
**Definition of Done:**
- [ ] `docs/architecture.md` - Agent pipeline documented
- [ ] `docs/user_guide.md` - Orchestration workflow guide added
- [ ] Example workflow from idea to completed tasks documented

---

### Phase 3: Polish and Validation (Scaling/Polish)

**Goal:** Ensure robustness, update remaining references, validate workflows.

#### Task 3.1: End-to-End Workflow Validation
**Definition of Done:**
- [ ] Manual test: Create task without template, agent generates content
- [ ] Manual test: Full orchestration pipeline (roadmap → tasks)
- [ ] Manual test: Execution pipeline (plan → code → audit → complete)

#### Task 3.2: Update E2E Tests
**Definition of Done:**
- [ ] `core-workflows.test.ts` - Template tests removed
- [ ] New E2E tests for agent-based task creation
- [ ] Orchestration workflow E2E test (if feasible)

#### Task 3.3: Final Cleanup
**Definition of Done:**
- [ ] `bun run typecheck` passes
- [ ] `bun run lint` passes
- [ ] `bun run test` passes (all unit/integration tests)
- [ ] `bun run test:e2e` passes
- [ ] `bun run build` produces valid extension

#### Task 3.4: Migration Guide for Existing Users
**Definition of Done:**
- [ ] MIGRATION.md or section in README created
- [ ] Steps to migrate existing workspaces documented
- [ ] Decision on existing `_templates/` folders (delete or ignore)

---

## 4. Files Summary

### Files to DELETE

| File | Reason |
|------|--------|
| `src/services/template.ts` | Core template service |
| `src/webview/ui/components/TemplatePicker.tsx` | Template picker UI |
| `src/webview/ui/components/TemplateModal.tsx` | Template edit modal |
| `tests/template-service.test.ts` | Template service tests |
| `.kanban2code/_templates/tasks/*.md` | All task templates |
| `.kanban2code/_templates/context/*.md` | Context templates (evaluate) |

### Files to CREATE

| File | Purpose |
|------|---------|
| `.kanban2code/_agents/roadmapper.md` | Orchestration: idea → vision |
| `.kanban2code/_agents/architect.md` | Orchestration: design phases/tasks |
| `.kanban2code/_agents/splitter.md` | Orchestration: generate task files |
| `.kanban2code/_agents/planner.md` | Execution: refine task, gather context |
| `.kanban2code/_agents/coder.md` | Execution: implement code |
| `.kanban2code/_agents/auditor.md` | Execution: review and rate |
| `src/assets/agents.ts` (optional) | Bundled agent content constants |

### Files to MODIFY

| File | Changes |
|------|---------|
| `src/webview/messaging.ts` | Remove 8 template message types |
| `src/webview/SidebarProvider.ts` | Remove template handlers (~60 lines) |
| `src/webview/KanbanPanel.ts` | Remove template handlers (~60 lines) |
| `src/webview/ui/components/TaskModal.tsx` | Remove TemplatePicker section |
| `src/webview/ui/components/TaskEditorModal.tsx` | Remove template loading/picker |
| `src/webview/ui/components/Board.tsx` | Remove TemplateModal state |
| `src/webview/ui/components/Sidebar.tsx` | Remove TemplateModal state |
| `src/webview/ui/components/Icons.tsx` | Remove TemplateIcon (if unused) |
| `src/webview/ui/components/index.ts` | Remove TemplatePicker export |
| `src/webview/ui/hooks/useTaskData.ts` | Remove TaskTemplate interface |
| `src/services/scaffolder.ts` | Remove template dirs, add agent copying |
| `src/services/context.ts` | Update/remove loadStageTemplate |
| `src/services/prompt-builder.ts` | Update stage template layer |
| `src/services/task-content.ts` | Remove template metadata field |
| `src/assets/templates.ts` | Remove task templates, add agents |
| `src/core/constants.ts` | Remove TEMPLATES_FOLDER |
| `src/commands/index.ts` | Remove newTemplate command |
| `src/types/filters.ts` | Add orchestration tags |
| `package.json` | Remove template command |
| `docs/architecture.md` | Update for new architecture |
| `.kanban2code/_context/ai-guide.md` | Remove templates, add orchestration |
| `tests/scaffolder.test.ts` | Update for new behavior |
| `tests/context-service.test.ts` | Update stage template tests |
| `tests/webview/task-editor-modal.test.tsx` | Remove template tests |
| `tests/e2e/core-workflows.test.ts` | Update for no templates |

---

## 5. Clarification Questions

Before proceeding with implementation, these critical details need clarification:

### Q1: Stage Templates Fate
**Current:** Stage templates (`_templates/stages/{stage}.md`) are loaded by `prompt-builder.ts` as part of the 9-layer context system.

**Options:**
- **A)** Keep stage templates but move to `_context/stages/` (not part of template removal)
- **B)** Embed stage context directly in agent instruction files
- **C)** Remove stage templates entirely (agents get stage from task frontmatter only)

**Impact:** Affects context.ts, prompt-builder.ts, scaffolder.ts

### Q2: Existing Workspace Migration
**Question:** When users upgrade to the new version, what happens to their existing `_templates/` folders?

**Options:**
- **A)** Silently ignore them (no breaking change, just unused)
- **B)** Show a one-time migration notice
- **C)** Automatically delete them
- **D)** Provide a migration command

### Q3: Agent File Bundling Strategy
**Question:** How should agent files be bundled and distributed?

**Options:**
- **A)** Embed as string constants in `src/assets/agents.ts` (like current templates.ts)
- **B)** Include as static files in `media/agents/` and copy at runtime
- **C)** Store in extension settings as defaults

**Recommendation:** Option A matches existing pattern

### Q4: Context Templates (`.kanban2code/_templates/context/`)
**Question:** The roadmap mentions removing `_templates/tasks/` and `_templates/stages/`, but not `_templates/context/`. Should context templates also be removed?

**Current files:**
- `_templates/context/phase-context.md`
- `_templates/context/audit-phase.md`

**Options:**
- **A)** Remove all of `_templates/` including context templates
- **B)** Keep context templates but move to `_context/_templates/`
- **C)** Keep `_templates/context/` as-is (only remove tasks/stages)

### Q5: Auditor Rating Threshold
**Question:** The roadmap specifies auditor ratings 8-10 = accepted, <8 = needs work. Should this be configurable in `config.json`?

**Options:**
- **A)** Hardcoded threshold of 8
- **B)** Configurable via config.json `auditor.acceptanceThreshold`

---

## 6. Testing Requirements

### Unit Tests to Update/Add

| Test File | Changes |
|-----------|---------|
| `tests/scaffolder.test.ts` | Verify no `_templates/` creation, verify `_agents/` creation |
| `tests/context-service.test.ts` | Update stage template tests based on Q1 decision |
| `tests/prompt-builder.test.ts` | Update stage template layer tests |

### Unit Tests to Delete

| Test File | Reason |
|-----------|--------|
| `tests/template-service.test.ts` | Service being removed |

### Component Tests to Update

| Test File | Changes |
|-----------|---------|
| `tests/webview/task-editor-modal.test.tsx` | Remove template loading tests |
| `tests/webview/board.test.tsx` | Remove template-related tests if any |

### E2E Tests to Update

| Test File | Changes |
|-----------|---------|
| `tests/e2e/core-workflows.test.ts` | Update task creation flows, add agent workflow tests |

### New Tests to Add

| Test | Purpose |
|------|---------|
| Agent loading test | Verify bundled agents are copied correctly |
| Orchestration tag validation | Verify tag taxonomy for orchestration |
| Task creation without templates | Verify basic task creation works |

### Test Commands to Run

```bash
bun run typecheck     # Type checking
bun run lint          # Linting
bun run test          # Unit/integration tests
bun run test:coverage # Coverage thresholds (70%+)
bun run test:e2e      # End-to-end tests
```

---

## 7. Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Breaking existing workspaces | Medium | High | Provide migration guide, silent ignore of old folders |
| Missing template references | Low | Medium | Thorough grep/search before finalizing |
| Stage context regression | Medium | Medium | Clarify Q1 before implementation |
| Test coverage drop | Low | Low | Update tests alongside code changes |

---

## Active Refactors (Original Roadmap)

### 1. Remove Template System

**Status:** Planned
**Priority:** High
**Reason:** Templates are passive, take up conceptual space, and don't fit the agent-driven workflow

**What Gets Removed:**
- `.kanban2code/_templates/tasks/` folder and all task templates
- `.kanban2code/_templates/stages/` folder and all stage templates
- `src/services/template.ts` service
- Template loading/resolution logic
- Template picker UI components
- Template-related messaging (RequestTemplates, TemplateContentLoaded, etc.)
- Template references in task frontmatter

**What Replaces It:**
- Agents generate task content on-demand
- Stage context embedded in agent instructions
- No UI for template selection (agents just write content)

---

### 2. Agent-Driven Orchestration Pipeline

**Status:** Design Phase
**Priority:** High

**Goal:**
Create specialized agents for roadmap → architecture → decomposition → execution workflow.

**Agents to Create:**

**Orchestration Agents (Meta-workflow):**
1. **Roadmapper** (Sonnet) - Idea exploration and vision document creation
2. **Architect** (Opus) - Edits roadmap to add technical design, phases, tasks, tests, files, and context
3. **Splitter** (GLM) - Reads roadmap and generates individual task markdown files

**Execution Agents (5-stage workflow):**
4. **Planner** (Sonnet/Opus) - Two responsibilities: (1) Refines/improves the task prompt, (2) Gathers necessary context (code, tests, patterns). Appends context and refined prompt to task file (stage: plan)
5. **Coder** (Codex) - General-purpose coding agent. Executes the plan and writes code. Future: project-specific variants (Ncoder for Next.js, Pcoder for Python, etc.) (stage: code)
6. **Auditor** (Codex-high) - Reviews code and assigns quality rating 1-10. Rating 8-10 = accepted for production, moves to completed. Rating <8 = needs work, moves back to code stage (stage: audit)

**Key Design Decisions:**
- Use **tags** (not checklists) to track orchestration state
  - Negative tags: `missing-architecture`, `missing-decomposition`, `missing-tests`
  - Positive tags: `architecture-ready`, `decomposition-ready`
- Each agent spawns the next task in the pipeline
- Parent/child relationships track the orchestration chain
- 5-stage model stays for execution tasks
- Meta-tasks (roadmap, architecture, decomposition) skip code/audit stages
- **Prompt Optimization Strategy:**
  - **Human prompts** - User needs to read/understand the output (readable, clear)
  - **Robot prompts** - AI-to-AI communication, optimize for AI efficiency (can be dense/technical)

**Agent Prompt Types:**
- **Roadmapper**: HUMAN (user reads vision document and needs to understand it)
- **Architect**: HUMAN (user reviews architecture decisions and technical design)
- **Splitter**: ROBOT (mechanical task file generation, user reads the output files not the process)
- **Planner**: HUMAN (user needs to understand context gathered and prompt refinement)
- **Coder**: ROBOT (user reads the code, not the reasoning; optimize for code quality)
- **Auditor**: HUMAN (user needs to understand review feedback and ratings)

**Tag Conventions:**

```yaml
# Roadmap task (Orchestration meta-task)
tags: [roadmap, p0]
# On handoff, Roadmapper adds to spawned Architect task:
tags: [architecture, p0, missing-architecture, missing-decomposition]

# Architect task (Orchestration meta-task, after handoff from Roadmapper)
tags: [architecture, p0, missing-architecture, missing-decomposition]
# On handoff, Architect removes missing-architecture, adds to spawned Splitter task:
tags: [decomposition, p0, missing-decomposition]

# Splitter task (Orchestration meta-task, after handoff from Architect)
tags: [decomposition, p0, missing-decomposition]
# Splitter generates task files, removes missing-decomposition

# Execution task (normal 5-stage workflow, generated by Splitter)
tags: [feature, p1]  # Goes through: inbox → plan → code → audit → completed
# Planner agent works on tasks in "plan" stage
# Coder agent works on tasks in "code" stage
# Auditor agent works on tasks in "audit" stage
```

**Implementation:**
- **IMPORTANT**: These agents must ship with the extension, not just live in project workspaces
- Agent files should be bundled with the extension and copied/scaffolded into new workspaces
- Create agent markdown files in `.kanban2code/_agents/`
- Document handoff protocol in ai-guide.md
- Update user guide with orchestration workflow
- Add examples of full pipeline
- Update scaffolder to include these agents in new workspaces

---

## Future Considerations

### 3. Workflow Automation

**Status:** Future
**Priority:** Medium

Once manual orchestration workflow is validated, consider:
- Automatic task spawning (agents create follow-up tasks)
- "Gather context" CLI command
- Backend agent activation triggers
- Workflow templates (multi-step pipelines)

**Wait until:** Manual workflow is proven and patterns are clear.

### 4. Board Layout Improvements

**Status:** Ideas
**Priority:** Low

Potential improvements:
- Visual distinction for meta-tasks vs execution tasks
- Tag-based coloring for orchestration states
- Filter presets for "incomplete orchestration work"

---

## Notes

- **Philosophy:** Don't over-engineer for rare operations. Orchestration happens once per feature; use simple tags.
- **Manual first:** Validate workflows manually before automating.
- **Model specialization:** Leverage different model strengths (Sonnet for conversation, Opus for architecture, GLM for cheap tasks, Codex for coding).
